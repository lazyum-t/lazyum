<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lazyum - çŸ¥è­˜ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹</title>
    
    <meta name="google-signin-client_id" content="YOUR_CLIENT_ID.apps.googleusercontent.com">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        .logo-image {
            width: 40px;
            height: 40px;
            margin-right: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF4458;
            --secondary: #667eea;
            --accent: #764ba2;
            --bg: #f5f5f5;
            --text: #333;
            --border: #ddd;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--text);
        }

        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #e63946;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: var(--warning);
            color: black;
        }

        .btn-block {
            width: 100%;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        .textarea-field {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .hidden {
            display: none !important;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 15px 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid var(--border);
            border-radius: 25px;
            font-size: 14px;
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.1);
        }

        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            box-shadow: 0 4px 12px rgba(255, 68, 88, 0.4);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            z-index: 90;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 68, 88, 0.5);
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-image {
            height: 200px;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            position: relative;
        }

        .card-content {
            padding: 15px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .genre-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-open {
            background: var(--success);
            color: white;
        }

        .status-reserved {
            background: var(--warning);
            color: black;
        }

        .status-solved {
            background: #6c757d;
            color: white;
        }

        .deadline-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        /* ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .image-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .image-upload:hover {
            border-color: var(--primary);
            background: rgba(255, 68, 88, 0.05);
        }

        .image-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            position: relative;
        }

        .image-preview .remove-image {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        .timer {
            display: inline-block;
            padding: 5px 10px;
            background: var(--warning);
            color: black;
            border-radius: 5px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* PayPayæ±ºæ¸ˆãƒœã‚¿ãƒ³ */
        .paypay-btn {
            background: #ff0033;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            width: 100%;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .paypay-btn:hover {
            background: #e60030;
        }

        /* ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 2001;
        }

        .image-modal-close:hover {
            color: #f1f1f1;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
            }

            .search-container {
                order: 3;
                flex: 1 1 100%;
                margin-top: 15px;
            }

            .grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" src="" alt="æ‹¡å¤§ç”»åƒ">
    </div>

    <div id="answerModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">å›ç­”ã‚’æå‡º</h2>
            <form onsubmit="handleAnswerSubmit(event)">
                <div class="input-group">
                    <label class="input-label">å†™çœŸï¼ˆä»»æ„ï¼‰</label>
                    <div class="image-upload" onclick="document.getElementById('answerImageInput').click()">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“·</div>
                        <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                        <input type="file" id="answerImageInput" accept="image/*" multiple style="display: none;" onchange="handleAnswerImageSelect(event)">
                    </div>
                    <div id="answerImagePreview" class="image-preview"></div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">å›ç­”èª¬æ˜</label>
                    <textarea id="answerDescription" class="textarea-field" placeholder="å›ç­”ã®è©³ç´°ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
                </div>
                
                <p style="color: var(--danger); margin-bottom: 20px;">â€» å†™çœŸã¾ãŸã¯èª¬æ˜æ–‡ã®å°‘ãªãã¨ã‚‚1ã¤ã¯å¿…é ˆã§ã™</p>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="closeAnswerModal()" class="btn btn-secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">å›ç­”ã‚’æå‡º</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        const app = {
            currentUser: null,
            currentPage: '',
            questions: [],
            displayedQuestions: 100,
            searchTerm: '',
            selectedImages: [],
            answerImages: [],
            currentAnsweringQuestion: null,
            answerTimers: {},
            penalties: {},
            showOnlyOpen: false,
            viewedAnswers: JSON.parse(localStorage.getItem('lazyum_viewed_answers') || '[]')
        };

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆLocalStorageï¼‰
        const db = {
            users: JSON.parse(localStorage.getItem('lazyum_users') || '[]'),
            questions: JSON.parse(localStorage.getItem('lazyum_questions') || '[]'),
            penalties: JSON.parse(localStorage.getItem('lazyum_penalties') || '{}'),
            blockedQuestions: JSON.parse(localStorage.getItem('lazyum_blocked_questions') || '{}'),
            
            saveUsers() {
                localStorage.setItem('lazyum_users', JSON.stringify(this.users));
            },
            
            saveQuestions() {
                localStorage.setItem('lazyum_questions', JSON.stringify(this.questions));
            },
            
            savePenalties() {
                localStorage.setItem('lazyum_penalties', JSON.stringify(this.penalties));
            },
            
            saveBlockedQuestions() {
                localStorage.setItem('lazyum_blocked_questions', JSON.stringify(this.blockedQuestions));
            },
            
            saveCurrentUser(user) {
                if (user) {
                    localStorage.setItem('lazyum_current_user', JSON.stringify(user));
                } else {
                    localStorage.removeItem('lazyum_current_user');
                }
            },
            
            getCurrentUser() {
                const user = localStorage.getItem('lazyum_current_user');
                return user ? JSON.parse(user) : null;
            }
        };

        // ãƒšãƒŠãƒ«ãƒ†ã‚£ç®¡ç†
        const penaltyManager = {
            checkPenalty(userId) {
                const penalty = db.penalties[userId];
                if (!penalty) return { canAnswer: true };
                
                // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‡çµãƒã‚§ãƒƒã‚¯
                if (penalty.frozenCount >= 3) {
                    return { canAnswer: false, reason: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ°¸ä¹…å‡çµã•ã‚Œã¦ã„ã¾ã™' };
                }
                
                // ä¸€æ™‚åœæ­¢ãƒã‚§ãƒƒã‚¯
                if (penalty.suspendedUntil && new Date(penalty.suspendedUntil) > new Date()) {
                    const remainingTime = new Date(penalty.suspendedUntil) - new Date();
                    const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
                    return { canAnswer: false, reason: `å›ç­”åœæ­¢ä¸­ï¼ˆæ®‹ã‚Š${days}æ—¥ï¼‰` };
                }
                
                return { canAnswer: true };
            },
            
            addFailure(userId) {
                if (!db.penalties[userId]) {
                    db.penalties[userId] = {
                        failures: [],
                        suspendedUntil: null,
                        suspendedCount: 0,
                        frozenCount: 0
                    };
                }
                
                const penalty = db.penalties[userId];
                const now = new Date();
                
                // 1é€±é–“ä»¥å†…ã®å¤±æ•—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                penalty.failures.push(now.toISOString());
                const oneWeekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                penalty.failures = penalty.failures.filter(f => new Date(f) > oneWeekAgo);
                
                // 5å›ä»¥ä¸Šã®å¤±æ•—ã§1é€±é–“åœæ­¢
                if (penalty.failures.length >= 5) {
                    penalty.suspendedUntil = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString();
                    penalty.suspendedCount++;
                    penalty.failures = [];
                    
                    // 3å›åœæ­¢ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‡çµ
                    if (penalty.suspendedCount >= 3) {
                        penalty.frozenCount = 3;
                        alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ°¸ä¹…å‡çµã•ã‚Œã¾ã—ãŸã€‚');
                    } else {
                        alert(`1é€±é–“ã®å›ç­”åœæ­¢å‡¦åˆ†ã¨ãªã‚Šã¾ã—ãŸï¼ˆ${penalty.suspendedCount}å›ç›®ï¼‰`);
                    }
                }
                
                db.savePenalties();
            }
        };

        // ã‚¿ã‚¤ãƒãƒ¼ç®¡ç†
        const timerManager = {
            startTimer(questionId, userId, duration = 2 * 60 * 60 * 1000) {
                const endTime = new Date().getTime() + duration;
                app.answerTimers[questionId] = {
                    userId: userId,
                    endTime: endTime,
                    canCancel: new Date().getTime() + 15 * 60 * 1000 // 15åˆ†é–“ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½
                };
                
                // ã‚¿ã‚¤ãƒãƒ¼ç›£è¦–
                const interval = setInterval(() => {
                    const now = new Date().getTime();
                    const timer = app.answerTimers[questionId];
                    
                    if (!timer || now > timer.endTime) {
                        clearInterval(interval);
                        if (timer && timer.userId === userId) {
                            this.handleTimeout(questionId, userId);
                        }
                    }
                }, 1000);
            },
            
            handleTimeout(questionId, userId) {
                const question = db.questions.find(q => q.id === questionId);
                if (question && question.status === 'reserved' && question.answeredBy === userId) {
                    question.status = 'open';
                    question.answeredBy = null;
                    delete app.answerTimers[questionId];
                    db.saveQuestions();
                    
                    // ãƒšãƒŠãƒ«ãƒ†ã‚£è¿½åŠ 
                    penaltyManager.addFailure(userId);
                    
                    if (app.currentPage === 'question' && app.currentQuestion?.id === questionId) {
                        router.render('question', questionId);
                    }
                }
            },
            
            canCancelAnswer(questionId) {
                const timer = app.answerTimers[questionId];
                if (!timer) return false;
                return new Date().getTime() < timer.canCancel;
            },
            
            cancelAnswer(questionId, userId) {
                const question = db.questions.find(q => q.id === questionId);
                if (question && this.canCancelAnswer(questionId)) {
                    question.status = 'open';
                    question.answeredBy = null;
                    delete app.answerTimers[questionId];
                    
                    // ã“ã®å•é¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯
                    if (!db.blockedQuestions[userId]) {
                        db.blockedQuestions[userId] = [];
                    }
                    db.blockedQuestions[userId].push(questionId);
                    
                    db.saveQuestions();
                    db.saveBlockedQuestions();
                    
                    alert('å›ç­”ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚ã“ã®å•é¡Œã«ã¯å†åº¦å›ç­”ã§ãã¾ã›ã‚“ã€‚');
                    router.navigate('home');
                }
            },
            
            getRemainingTime(questionId) {
                const timer = app.answerTimers[questionId];
                if (!timer) return null;
                
                const now = new Date().getTime();
                const remaining = timer.endTime - now;
                
                if (remaining <= 0) return 'æ™‚é–“åˆ‡ã‚Œ';
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                return `${hours}æ™‚é–“${minutes}åˆ†${seconds}ç§’`;
            }
        };

        // ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        const pages = {
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
            login: () => `
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--secondary), var(--accent)); display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ˜´</div>
                            <h1 style="font-size: 32px; color: var(--primary); margin-bottom: 10px;">lazyum</h1>
                            <p style="color: #666;">çŸ¥è­˜ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹</p>
                        </div>
                        
                        <form onsubmit="handleLogin(event)">
                            <div class="input-group">
                                <input type="email" id="loginEmail" class="input-field" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
                            </div>
                            <div class="input-group">
                                <input type="password" id="loginPassword" class="input-field" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </form>
                        
                        <div style="margin: 20px 0; text-align: center; position: relative;">
                            <div style="border-top: 1px solid var(--border); margin: 20px 0;"></div>
                            <span style="background: white; padding: 0 10px; position: relative; top: -30px; color: #999;">ã¾ãŸã¯</span>
                        </div>
                        
                        <div id="googleSignInButton" style="display: flex; justify-content: center; margin-bottom: 20px;"></div>
                        
                        <button onclick="router.navigate('signup')" class="btn btn-secondary btn-block">æ–°è¦ç™»éŒ²</button>
                        
                        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404; font-size: 14px;">
                            <strong>ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</strong><br>
                            ãƒ¡ãƒ¼ãƒ«: test@test.com<br>
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: password
                        </div>
                    </div>
                </div>
            `,

            // æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸
            signup: () => `
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--secondary), var(--accent)); display: flex; align-items: center; justify-content: center; padding: 20px;">
                    <div style="background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ˜´</div>
                            <h1 style="font-size: 32px; color: var(--primary); margin-bottom: 10px;">æ–°è¦ç™»éŒ²</h1>
                            <p style="color: #666;">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</p>
                        </div>
                        
                        <form onsubmit="handleSignup(event)">
                            <div class="input-group">
                                <label class="input-label">åå‰</label>
                                <input type="text" id="signupName" class="input-field" placeholder="è¡¨ç¤ºå" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" id="signupEmail" class="input-field" placeholder="example@email.com" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                                <input type="password" id="signupPassword" class="input-field" placeholder="8æ–‡å­—ä»¥ä¸Š" minlength="8" required>
                            </div>
                            <button type="submit" class="btn btn-primary btn-block">ç™»éŒ²ã™ã‚‹</button>
                        </form>
                        
                        <div style="text-align: center; margin-top: 20px; color: #666;">
                            ã™ã§ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯
                            <a href="#" onclick="router.navigate('login'); return false;" style="color: var(--primary); text-decoration: none;">ãƒ­ã‚°ã‚¤ãƒ³</a>
                        </div>
                    </div>
                </div>
            `,

            // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
            home: () => {
                const questions = getFilteredQuestions();
                const displayQuestions = questions.slice(0, app.displayedQuestions);
                
                // æœŸé™åˆ‡ã‚Œè³ªå•ã®å‰Šé™¤
                checkAndRemoveExpiredQuestions();
                
                // æ–°ç€å›ç­”ãƒã‚§ãƒƒã‚¯
                const newAnswers = checkNewAnswers();
                
                return `
                    <div>
                        ${header()}
                        
                        ${app.currentUser && checkAccountStatus()}
                        
                        ${newAnswers.length > 0 ? `
                            <div class="container" style="margin-top: 20px;">
                                <div class="alert alert-success" style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>ğŸ“¬ å›ç­”ãŒè¿”ã£ã¦ãã¾ã—ãŸï¼ï¼ˆ${newAnswers.length}ä»¶ï¼‰</span>
                                    <button onclick="viewNewAnswers()" class="btn btn-primary" style="padding: 8px 16px;">å›ç­”ã‚’ç¢ºèªã™ã‚‹</button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="container" style="padding: 30px 20px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="showOnlyOpen" onchange="toggleOnlyOpen()" ${app.showOnlyOpen ? 'checked' : ''}>
                                    <span>å‹Ÿé›†ä¸­ã®ã¿è¡¨ç¤º</span>
                                </label>
                            </div>
                            
                            ${displayQuestions.length === 0 ? `
                                <div style="text-align: center; padding: 60px 20px; color: #999;">
                                    <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”­</div>
                                    <h2 style="font-size: 24px; margin-bottom: 10px;">ã¾ã è³ªå•ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                                    <p>æœ€åˆã®è³ªå•ã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                                </div>
                            ` : `
                                <div class="grid">
                                    ${displayQuestions.map(q => questionCard(q)).join('')}
                                </div>
                                
                                ${questions.length > app.displayedQuestions ? `
                                    <div style="text-align: center; margin: 40px 0;">
                                        <button onclick="loadMoreQuestions()" class="btn btn-secondary">
                                            ã•ã‚‰ã«è¦‹ã‚‹ï¼ˆæ®‹ã‚Š${questions.length - app.displayedQuestions}ä»¶ï¼‰
                                        </button>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                        
                        <a href="#" onclick="router.navigate('post'); return false;" class="fab">+</a>
                    </div>
                `;
            },

            // æŠ•ç¨¿ãƒšãƒ¼ã‚¸
            post: () => `
                <div>
                    ${header()}
                    <div class="container" style="padding: 30px 20px; max-width: 800px;">
                        <div class="card" style="padding: 30px;">
                            <h1 style="margin-bottom: 30px;">è³ªå•ã‚’æŠ•ç¨¿</h1>
                            <form id="postForm" onsubmit="handlePost(event)">
                                <div class="input-group">
                                    <label class="input-label">å†™çœŸï¼ˆæœ€å¤§5æšï¼‰</label>
                                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“·</div>
                                        <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                                        <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
                                    </div>
                                    <div id="imagePreview" class="image-preview"></div>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
                                    <input type="text" id="postTitle" class="input-field" placeholder="è³ªå•ã®ã‚¿ã‚¤ãƒˆãƒ«" required oninput="checkFormCompletion()">
                                </div>
                                <div class="input-group">
                                    <label class="input-label">èª¬æ˜æ–‡ *</label>
                                    <textarea id="postDescription" class="textarea-field" placeholder="è©³ã—ã„èª¬æ˜ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„" required oninput="checkFormCompletion()"></textarea>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                                    <select id="postCategory" class="input-field" required onchange="updateSubCategory(); checkFormCompletion();">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        <option value="ç¤¾ä¼šäºº">ç¤¾ä¼šäºº</option>
                                        <option value="å¤§å­¦ç”Ÿ">å¤§å­¦ç”Ÿ</option>
                                        <option value="é«˜æ ¡ç”Ÿ">é«˜æ ¡ç”Ÿ</option>
                                        <option value="ä¸­å­¦ç”Ÿ">ä¸­å­¦ç”Ÿ</option>
                                        <option value="å°å­¦ç”Ÿ">å°å­¦ç”Ÿ</option>
                                        <option value="ãã®ä»–">ãã®ä»–</option>
                                    </select>
                                </div>
                                <div id="subCategoryGroup" class="input-group" style="display: none;">
                                    <label class="input-label">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                                    <select id="postSubCategory" class="input-field" onchange="updateDetailCategory(); checkFormCompletion();">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    </select>
                                </div>
                                <div id="detailCategoryGroup" class="input-group" style="display: none;">
                                    <label class="input-label">è©³ç´°ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
                                    <select id="postDetailCategory" class="input-field" onchange="checkFormCompletion()">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">å˜ä¾¡ï¼ˆå††ï¼‰ *</label>
                                    <input type="number" id="postPrice" class="input-field" placeholder="500" min="100" step="100" required oninput="checkFormCompletion()">
                                    <small style="color: #666; display: block; margin-top: 5px;"> â€» æ‰‹æ•°æ–™10%ï¼ˆã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ–™ï¼‰ </small>
                                    <div id="rewardDisplay" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 8px; color: #2e7d32; font-size: 14px; display: none;"></div>
                                </div>
                                <div class="input-group">
                                    <label class="input-label">å‹Ÿé›†æœŸé™ï¼ˆä»»æ„ï¼‰</label>
                                    <input type="datetime-local" id="postDeadline" class="input-field">
                                    <small style="color: #666; display: block; margin-top: 5px;"> æœŸé™ã‚’éãã‚‹ã¨è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ </small>
                                </div>
                                <div id="incompleteWarning" class="alert alert-warning" style="display: none;"> å…¥åŠ›ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™ </div>
                                <div id="paymentMessage" style="margin-top: 10px; text-align: center;"></div>
                                <button type="button" id="payButton" onclick="initiatePayPay()" class="paypay-btn" disabled>
                                    <span>ğŸ’³</span> <span>PayPayã§æ”¯æ‰•ã„ã—ã¦æŠ•ç¨¿</span>
                                </button>
                                <button type="button" onclick="router.navigate('home')" class="btn btn-secondary btn-block" style="margin-top: 10px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            </form>
                        </div>
                    </div>
                </div>
            `,

            // å›ç­”å®Œäº†ãƒšãƒ¼ã‚¸
            answerComplete: (data) => {
                const reward = data ? Math.floor(data.price * 0.9) : 0;
                return `
                    <div style="min-height: 100vh; background: linear-gradient(135deg, var(--secondary), var(--accent)); display: flex; align-items: center; justify-content: center; padding: 20px;">
                        <div style="background: white; border-radius: 20px; padding: 40px; width: 100%; max-width: 500px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); text-align: center;">
                            <div style="font-size: 64px; margin-bottom: 20px;">âœ…</div>
                            <h1 style="font-size: 28px; color: var(--primary); margin-bottom: 20px;">å›ç­”ãŒå®Œäº†ã—ã¾ã—ãŸ</h1>
                            <div style="background: #f8f9fa; padding: 30px; border-radius: 12px; margin: 30px 0;">
                                <p style="font-size: 18px; color: #666; margin-bottom: 15px;">å ±é…¬</p>
                                <p style="font-size: 36px; font-weight: bold; color: var(--primary);"> Â¥${reward.toLocaleString()} </p>
                                <p style="font-size: 14px; color: #999; margin-top: 15px;"> å ±é…¬ã¯ç´„2é€±é–“å¾Œã«ç²å¾—ã§ãã¾ã™ </p>
                            </div>
                            <button onclick="router.navigate('home')" class="btn btn-primary btn-block"> ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ </button>
                        </div>
                    </div>
                `;
            },

            // è³ªå•è©³ç´°ãƒšãƒ¼ã‚¸
            question: (id) => {
                const question = db.questions.find(q => q.id === parseInt(id));
                if (!question) return '<div>è³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';

                const isMyQuestion = question.userId === app.currentUser?.id;
                const isAnswering = question.answeredBy === app.currentUser?.id && question.status === 'reserved';
                const canAnswer = !isMyQuestion && question.status === 'open' && !db.blockedQuestions[app.currentUser?.id]?.includes(question.id);

                const timer = app.answerTimers[question.id];
                const canCancelAnswer = timer && timerManager.canCancelAnswer(question.id);

                return `
                    <div>
                        ${header()}
                        <div class="container" style="padding: 30px 20px; max-width: 800px;">
                            <div class="card" style="padding: 30px;">
                                <h1 style="margin-bottom: 20px;">${question.title}</h1>
                                
                                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                                    <span class="genre-badge" style="position: static; background: var(--secondary); margin-right: 0;">${question.category}</span>
                                    ${question.subCategory ? `<span class="genre-badge" style="position: static; background: #6c757d; margin-right: 0;">${question.subCategory}</span>` : ''}
                                    ${question.detailCategory ? `<span class="genre-badge" style="position: static; background: #343a40; margin-right: 0;">${question.detailCategory}</span>` : ''}
                                    <span class="${getStatusBadgeClass(question.status)}" style="position: static;">${getStatusText(question.status)}</span>
                                    <span class="price" style="font-size: 18px; margin-left: auto;">Â¥${question.price.toLocaleString()}</span>
                                </div>
                                
                                ${isAnswering ? `
                                    <div class="alert alert-warning" style="margin-bottom: 20px; text-align: center;">
                                        <strong>å›ç­”äºˆç´„ä¸­:</strong> ${timerManager.getRemainingTime(question.id)}ä»¥å†…ã«å›ç­”ã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚
                                        ${canCancelAnswer ? `<button onclick="timerManager.cancelAnswer(${question.id}, ${app.currentUser.id})" class="btn btn-danger" style="margin-left: 20px; padding: 5px 15px;">äºˆç´„è§£é™¤</button>` : ''}
                                    </div>
                                ` : ''}

                                <p style="white-space: pre-wrap; margin-bottom: 20px; line-height: 1.8;">${question.description}</p>
                                
                                ${question.images && question.images.length > 0 ? `
                                    <div class="image-preview" style="margin-bottom: 20px;">
                                        ${question.images.map(img => `<img src="${img}" alt="è³ªå•ç”»åƒ" style="width: 150px; height: 150px; object-fit: cover; cursor: pointer;" onclick="openImageModal('${img}')">`).join('')}
                                    </div>
                                ` : ''}

                                <div style="color: #999; font-size: 14px; border-top: 1px solid var(--border); padding-top: 15px;">
                                    <span>æŠ•ç¨¿è€…: ${getUserName(question.userId)}</span>
                                    <span style="margin-left: 15px;">æŠ•ç¨¿æ—¥æ™‚: ${new Date(question.createdAt).toLocaleDateString()}</span>
                                    ${question.deadline ? `<span class="deadline-badge" style="position: static; margin-left: 15px; background: var(--danger);">æœŸé™: ${getDeadlineRemaining(question.deadline)}</span>` : ''}
                                </div>
                                
                                ${isMyQuestion && question.status === 'open' ? `
                                    <div style="margin-top: 20px;">
                                        <button onclick="handleDeleteQuestion(${question.id})" class="btn btn-danger">è³ªå•ã‚’å‰Šé™¤</button>
                                    </div>
                                ` : ''}
                                
                                ${canAnswer ? `
                                    <div style="margin-top: 30px; border-top: 2px solid var(--primary); padding-top: 20px;">
                                        ${checkPenaltyStatus(app.currentUser.id) === true ? `
                                            <button onclick="openAnswerModal(${question.id}, ${question.price})" class="btn btn-primary btn-block">å›ç­”ã™ã‚‹</button>
                                        ` : `
                                            <div class="alert alert-danger" style="text-align: center;">
                                                ${checkPenaltyStatus(app.currentUser.id)}
                                            </div>
                                        `}
                                    </div>
                                ` : ''}

                                ${question.status === 'solved' ? `
                                    <div style="margin-top: 30px; border-top: 2px solid var(--success); padding-top: 20px;">
                                        <h3 style="margin-bottom: 15px; color: var(--success);">è§£æ±ºæ¸ˆã¿ã®å›ç­”</h3>
                                        ${question.answers.map(a => answerCard(a, isMyQuestion)).join('')}
                                    </div>
                                ` : ''}

                            </div>
                        </div>
                    </div>
                `;
            },
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸
            profile: (id) => {
                const userId = id ? parseInt(id) : app.currentUser?.id;
                const user = db.users.find(u => u.id === userId);
                
                if (!user) return `
                    <div>
                        ${header()}
                        <div class="container" style="padding: 30px 20px;">
                            <div class="alert alert-danger">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
                        </div>
                    </div>
                `;

                const isMyProfile = user.id === app.currentUser?.id;
                const myQuestions = db.questions.filter(q => q.userId === user.id);
                const myAnswers = db.questions.flatMap(q => q.answers).filter(a => a.userId === user.id);
                
                return `
                    <div>
                        ${header()}
                        <div class="container" style="padding: 30px 20px; max-width: 800px;">
                            <div class="card" style="padding: 30px; text-align: center; margin-bottom: 30px;">
                                <div class="user-avatar" style="width: 80px; height: 80px; font-size: 36px; margin: 0 auto 15px;">${user.name.charAt(0)}</div>
                                <h1 style="margin-bottom: 10px;">${user.name}</h1>
                                <p style="color: #666; margin-bottom: 20px;">${user.email}</p>
                                
                                <div style="display: flex; justify-content: space-around; border-top: 1px solid var(--border); padding-top: 20px;">
                                    <div>
                                        <p style="font-size: 14px; color: #999;">æŠ•ç¨¿è³ªå•æ•°</p>
                                        <p style="font-size: 24px; font-weight: bold; color: var(--primary);">${myQuestions.length}</p>
                                    </div>
                                    <div>
                                        <p style="font-size: 14px; color: #999;">å›ç­”æ•°</p>
                                        <p style="font-size: 24px; font-weight: bold; color: var(--success);">${myAnswers.length}</p>
                                    </div>
                                </div>
                                
                                ${isMyProfile ? `
                                    <div style="margin-top: 30px;">
                                        <button onclick="handleLogout()" class="btn btn-secondary">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <h2 style="margin-bottom: 20px;">æŠ•ç¨¿ã—ãŸè³ªå• (${myQuestions.length})</h2>
                            ${myQuestions.length === 0 ? `<p style="color: #999;">è³ªå•ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>` : `
                                <div class="grid">
                                    ${myQuestions.map(q => questionCard(q)).join('')}
                                </div>
                            `}
                            
                            <h2 style="margin-top: 40px; margin-bottom: 20px;">å›ç­”ã—ãŸè³ªå• (${myAnswers.length})</h2>
                            ${myAnswers.length === 0 ? `<p style="color: #999;">å›ç­”ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>` : `
                                <div class="grid">
                                    ${myAnswers.map(a => {
                                        const q = db.questions.find(q => q.id === a.questionId);
                                        return q ? questionCard(q) : '';
                                    }).join('')}
                                </div>
                            `}

                        </div>
                    </div>
                `;
            },
            
            // 404ãƒšãƒ¼ã‚¸
            '404': () => `
                <div style="text-align: center; padding: 100px 20px; min-height: 100vh; background: var(--bg);">
                    <div style="font-size: 96px; margin-bottom: 20px;">ğŸš«</div>
                    <h1 style="font-size: 48px; margin-bottom: 10px;">404 Not Found</h1>
                    <p style="font-size: 18px; color: #666; margin-bottom: 30px;">ãŠæ¢ã—ã®ãƒšãƒ¼ã‚¸ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    <button onclick="router.navigate('home')" class="btn btn-primary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                </div>
            `
        };

        // ãƒ«ãƒ¼ã‚¿ãƒ¼ã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        const router = {
            navigate(page, id = null) {
                const hash = id ? `${page}/${id}` : page;
                history.pushState(null, null, `#${hash}`);
                this.render(page, id);
            },
            
            render(page, id = null) {
                app.currentPage = page;
                app.currentQuestion = db.questions.find(q => q.id === parseInt(id));

                const container = document.getElementById('app');
                const pageFunction = pages[page] || pages['404'];
                
                // ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æç”»
                container.innerHTML = pageFunction(id);
                
                // Googleã‚µã‚¤ãƒ³ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®å†æç”» (loginãƒšãƒ¼ã‚¸ã®å ´åˆ)
                if (page === 'login') {
                    renderGoogleSignInButton();
                }

                // è³ªå•æŠ•ç¨¿ãƒšãƒ¼ã‚¸ã®å ´åˆã€åˆæœŸåŒ–
                if (page === 'post') {
                    initPostPage();
                }
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒˆãƒƒãƒ—ã«æˆ»ã™
                window.scrollTo(0, 0);
            }
        };

        // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–¢æ•°
        function header() {
            const userAvatar = app.currentUser ? `<div class="user-avatar" onclick="router.navigate('profile')">${app.currentUser.name.charAt(0)}</div>` : `<button onclick="router.navigate('login')" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>`;
            
            return `
                <header class="header">
                    <div class="container header-content">
                        <a href="#" onclick="router.navigate('home'); return false;" class="logo">
                            <div class="logo-image">ğŸ˜´</div>
                            lazyum
                        </a>
                        <div class="search-container">
                            <input type="text" id="searchInput" class="search-input" placeholder="è³ªå•ã‚’æ¤œç´¢..." onkeyup="handleSearch(event)" value="${app.searchTerm}">
                            <button class="search-btn" onclick="router.render('home')">ğŸ”</button>
                        </div>
                        ${userAvatar}
                    </div>
                </header>
            `;
        }
        
        function questionCard(q) {
            const userName = getUserName(q.userId);
            const statusClass = getStatusBadgeClass(q.status);
            const statusText = getStatusText(q.status);
            const timerHtml = q.status === 'reserved' && app.answerTimers[q.id] ? `<span class="timer">${timerManager.getRemainingTime(q.id)}</span>` : '';
            const isNewAnswer = checkNewAnswerForQuestion(q.id);

            return `
                <a href="#" onclick="router.navigate('question', ${q.id}); return false;" class="card" style="text-decoration: none; color: inherit;">
                    <div class="card-image" style="background: url('${q.images && q.images.length > 0 ? q.images[0] : 'linear-gradient(135deg, var(--secondary), var(--accent))'}'); background-size: cover; background-position: center; ${q.images && q.images.length > 0 ? '' : 'font-size: 0;' /* ç”»åƒãŒãªã„å ´åˆã¯ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º */ }">
                        <span class="genre-badge">${q.category}</span>
                        <span class="${statusClass}">${statusText}</span>
                        ${q.deadline && q.status === 'open' ? `<span class="deadline-badge">æœŸé™: ${getDeadlineRemaining(q.deadline)}</span>` : ''}
                        ${isNewAnswer ? `<div class="status-badge" style="top: 40px; right: 10px; background: var(--primary); color: white;">æ–°ç€å›ç­”</div>` : ''}
                    </div>
                    <div class="card-content">
                        <h3 class="card-title">${q.title}</h3>
                        <div class="card-meta">
                            <div class="price">Â¥${q.price.toLocaleString()}</div>
                            <div style="font-size: 12px; color: #999;">${userName} ${timerHtml}</div>
                        </div>
                    </div>
                </a>
            `;
        }
        
        function answerCard(a, isMyQuestion) {
            const userName = getUserName(a.userId);
            
            return `
                <div class="card" style="margin-bottom: 20px; ${a.isAccepted ? 'border: 3px solid var(--success);' : ''}">
                    <div style="padding: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold; color: var(--text);">${userName}</span>
                            <span style="font-size: 12px; color: #999;">${new Date(a.answeredAt).toLocaleDateString()}</span>
                        </div>
                        
                        <p style="white-space: pre-wrap; margin-bottom: 15px; line-height: 1.6;">${a.description}</p>
                        
                        ${a.images && a.images.length > 0 ? `
                            <div class="image-preview" style="margin-bottom: 15px;">
                                ${a.images.map(img => `<img src="${img}" alt="å›ç­”ç”»åƒ" style="width: 100px; height: 100px; object-fit: cover; cursor: pointer;" onclick="openImageModal('${img}')">`).join('')}
                            </div>
                        ` : ''}
                        
                        ${a.isAccepted ? `
                            <div class="alert alert-success" style="padding: 10px; text-align: center;">âœ… æ¡ç”¨ã•ã‚ŒãŸå›ç­”ã§ã™</div>
                        ` : ''}

                        ${isMyQuestion && !a.isAccepted ? `
                            <div style="text-align: right; margin-top: 10px;">
                                <button onclick="handleAcceptAnswer(${a.questionId}, ${a.id})" class="btn btn-success" style="padding: 8px 16px;">ã“ã®å›ç­”ã‚’æ¡ç”¨ã™ã‚‹</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function checkAccountStatus() {
            const status = penaltyManager.checkPenalty(app.currentUser.id);
            if (!status.canAnswer) {
                return `
                    <div class="container" style="margin-top: 20px;">
                        <div class="alert alert-danger" style="text-align: center;">
                            âš ï¸ **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è­¦å‘Š:** ${status.reason}
                        </div>
                    </div>
                `;
            }
            return '';
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function getUserName(id) {
            const user = db.users.find(u => u.id === id);
            return user ? user.name : 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
        }
        
        function getStatusBadgeClass(status) {
            switch (status) {
                case 'open': return 'status-badge status-open';
                case 'reserved': return 'status-badge status-reserved';
                case 'solved': return 'status-badge status-solved';
                default: return 'status-badge';
            }
        }
        
        function getStatusText(status) {
            switch (status) {
                case 'open': return 'å‹Ÿé›†ä¸­';
                case 'reserved': return 'å›ç­”äºˆç´„ä¸­';
                case 'solved': return 'è§£æ±ºæ¸ˆã¿';
                default: return 'ä¸æ˜';
            }
        }

        function getDeadlineRemaining(deadline) {
            const diff = new Date(deadline) - new Date();
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            if (diff <= 0) return 'æœŸé™åˆ‡ã‚Œ';
            if (days > 0) return `æ®‹ã‚Š${days}æ—¥`;
            return `æ®‹ã‚Š${hours}æ™‚é–“`;
        }
        
        function checkPenaltyStatus(userId) {
            const status = penaltyManager.checkPenalty(userId);
            if (status.canAnswer) return true;
            return status.reason;
        }

        // ãƒ‡ãƒ¼ã‚¿æ“ä½œ
        function getFilteredQuestions() {
            let questions = db.questions.slice().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (app.showOnlyOpen) {
                questions = questions.filter(q => q.status === 'open');
            }
            
            if (app.searchTerm) {
                const term = app.searchTerm.toLowerCase();
                questions = questions.filter(q => 
                    q.title.toLowerCase().includes(term) ||
                    q.description.toLowerCase().includes(term) ||
                    q.category.toLowerCase().includes(term)
                );
            }
            
            return questions;
        }
        
        function checkAndRemoveExpiredQuestions() {
            const now = new Date();
            const initialCount = db.questions.length;
            
            db.questions = db.questions.filter(q => 
                !q.deadline || new Date(q.deadline) > now
            );
            
            if (db.questions.length !== initialCount) {
                db.saveQuestions();
            }
        }

        // æ–°ç€å›ç­”é€šçŸ¥
        function checkNewAnswers() {
            if (!app.currentUser) return [];
            
            // è‡ªåˆ†ãŒæŠ•ç¨¿ã—ãŸè³ªå•ã®ä¸­ã§ã€æœªèª­ã®å›ç­”ã‚’æŒã¤ã‚‚ã®ã‚’æŠ½å‡º
            return db.questions.filter(q => 
                q.userId === app.currentUser.id && // è‡ªåˆ†ã®è³ªå•
                q.answers && q.answers.length > 0 && // å›ç­”ãŒã‚ã‚‹
                q.answers.some(a => !app.viewedAnswers.includes(a.id)) // æœªèª­ã®å›ç­”ãŒã‚ã‚‹
            );
        }

        function checkNewAnswerForQuestion(questionId) {
             if (!app.currentUser) return false;
             
             const question = db.questions.find(q => q.id === questionId);
             if (!question || question.userId !== app.currentUser.id || !question.answers) return false;

             return question.answers.some(a => !app.viewedAnswers.includes(a.id));
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = db.users.find(u => u.email === email && u.password === password);
            
            if (user) {
                app.currentUser = user;
                db.saveCurrentUser(user);
                router.navigate('home');
            } else {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚');
            }
        }

        function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (db.users.some(u => u.email === email)) {
                alert('ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }
            
            const newUser = {
                id: db.users.length > 0 ? Math.max(...db.users.map(u => u.id)) + 1 : 1,
                name: name,
                email: email,
                password: password,
                googleId: null,
                createdAt: new Date().toISOString()
            };
            
            db.users.push(newUser);
            db.saveUsers();
            
            app.currentUser = newUser;
            db.saveCurrentUser(newUser);
            alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
            router.navigate('home');
        }

        function handleLogout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                app.currentUser = null;
                db.saveCurrentUser(null);
                // Google Sign-Out
                const googleAuth = typeof google !== 'undefined' ? google.accounts.id : null;
                if (googleAuth) {
                    googleAuth.disableAutoSelect();
                    // å¿…è¦ã«å¿œã˜ã¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¿½è¨˜
                }
                router.navigate('login');
            }
        }

        function handleGoogleCredentialResponse(response) {
            // Google One Tap ã¾ãŸã¯ Sign-In Buttonã‹ã‚‰ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (response.credential) {
                // èªè¨¼æƒ…å ±ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆã“ã“ã§ã¯çœç•¥ï¼‰
                const testUser = db.users.find(u => u.googleId);
                
                if (testUser) {
                    app.currentUser = testUser;
                    db.saveCurrentUser(testUser);
                    router.navigate('home');
                } else {
                    // æ–°è¦ç™»éŒ²å‡¦ç†ï¼ˆã“ã“ã§ã¯ç°¡æ˜“çš„ã«æ—¢å­˜ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ä»£ç”¨ï¼‰
                    alert('Googleèªè¨¼æˆåŠŸ (ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³)');
                    app.currentUser = db.users.find(u => u.id === 1);
                    db.saveCurrentUser(app.currentUser);
                    router.navigate('home');
                }
            }
        }

        function renderGoogleSignInButton() {
            const buttonDiv = document.getElementById('googleSignInButton');
            if (buttonDiv && typeof google !== 'undefined' && google.accounts.id) {
                google.accounts.id.initialize({
                    client_id: "YOUR_CLIENT_ID.apps.googleusercontent.com", // å®Ÿéš›ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã«ç½®ãæ›ãˆã¦ãã ã•ã„
                    callback: handleGoogleCredentialResponse,
                });

                google.accounts.id.renderButton(
                    buttonDiv,
                    { type: "standard", theme: "outline", size: "large", width: "360" } 
                );
            }
        }
        
        function handleSearch(e) {
            app.searchTerm = e.target.value;
            router.render('home');
        }
        
        function loadMoreQuestions() {
            app.displayedQuestions += 100;
            router.render('home');
        }
        
        function toggleOnlyOpen() {
            app.showOnlyOpen = document.getElementById('showOnlyOpen').checked;
            router.render('home');
        }

        // ç”»åƒå‡¦ç†ï¼ˆæŠ•ç¨¿ï¼‰
        function handleImageSelect(e) {
            const files = e.target.files;
            const maxFiles = 5;
            const newImages = [...app.selectedImages];

            for (let i = 0; i < files.length && newImages.length < maxFiles; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (newImages.length < maxFiles) {
                        newImages.push(event.target.result);
                        app.selectedImages = newImages;
                        renderImagePreview();
                        checkFormCompletion();
                    }
                };
                reader.readAsDataURL(file);
            }
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            e.target.value = '';
        }

        function renderImagePreview() {
            const previewDiv = document.getElementById('imagePreview');
            if (previewDiv) {
                previewDiv.innerHTML = app.selectedImages.map((img, index) => `
                    <div style="position: relative;">
                        <img src="${img}" alt="Preview ${index}" />
                        <span class="remove-image" onclick="removeImage(${index})">&times;</span>
                    </div>
                `).join('');
            }
        }

        function removeImage(index) {
            app.selectedImages.splice(index, 1);
            renderImagePreview();
            checkFormCompletion();
        }
        
        // ç”»åƒå‡¦ç†ï¼ˆå›ç­”ï¼‰
        function handleAnswerImageSelect(e) {
            const files = e.target.files;
            const maxFiles = 3;
            const newImages = [...app.answerImages];

            for (let i = 0; i < files.length && newImages.length < maxFiles; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (newImages.length < maxFiles) {
                        newImages.push(event.target.result);
                        app.answerImages = newImages;
                        renderAnswerImagePreview();
                    }
                };
                reader.readAsDataURL(file);
            }
            e.target.value = '';
        }

        function renderAnswerImagePreview() {
            const previewDiv = document.getElementById('answerImagePreview');
            if (previewDiv) {
                previewDiv.innerHTML = app.answerImages.map((img, index) => `
                    <div style="position: relative;">
                        <img src="${img}" alt="Preview ${index}" />
                        <span class="remove-image" onclick="removeAnswerImage(${index})">&times;</span>
                    </div>
                `).join('');
            }
        }

        function removeAnswerImage(index) {
            app.answerImages.splice(index, 1);
            renderAnswerImagePreview();
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«
        function openImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = src;
            modal.classList.add('show');
            // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢
            document.body.style.overflow = 'hidden';
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è¨±å¯
            document.body.style.overflow = '';
        }

        function openAnswerModal(questionId, price) {
            if (!app.currentUser) {
                alert('å›ç­”ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚');
                router.navigate('login');
                return;
            }

            if (!checkPenaltyStatus(app.currentUser.id)) return;

            // å›ç­”äºˆç´„å‡¦ç†
            const question = db.questions.find(q => q.id === questionId);
            if (question.status !== 'open') {
                alert('ã“ã®è³ªå•ã¯ç¾åœ¨å‹Ÿé›†ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                router.render('question', questionId);
                return;
            }
            
            question.status = 'reserved';
            question.answeredBy = app.currentUser.id;
            db.saveQuestions();
            
            // 2æ™‚é–“ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            timerManager.startTimer(questionId, app.currentUser.id);

            app.currentAnsweringQuestion = questionId;
            app.answerImages = [];
            renderAnswerImagePreview();
            document.getElementById('answerDescription').value = '';
            
            const modal = document.getElementById('answerModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // è³ªå•è©³ç´°ãƒšãƒ¼ã‚¸ã‚’å†æç”»ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°
            router.render('question', questionId);
        }

        function closeAnswerModal() {
            const modal = document.getElementById('answerModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function handleAnswerSubmit(e) {
            e.preventDefault();
            const description = document.getElementById('answerDescription').value.trim();
            
            if (app.answerImages.length === 0 && description === '') {
                alert('å†™çœŸã¾ãŸã¯èª¬æ˜æ–‡ã®å°‘ãªãã¨ã‚‚1ã¤ã¯å¿…é ˆã§ã™ã€‚');
                return;
            }
            
            const questionId = app.currentAnsweringQuestion;
            const question = db.questions.find(q => q.id === questionId);

            if (!question || question.answeredBy !== app.currentUser.id || question.status !== 'reserved') {
                alert('å›ç­”æ¨©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                closeAnswerModal();
                router.render('question', questionId);
                return;
            }

            const newAnswer = {
                id: question.answers.length > 0 ? Math.max(...question.answers.map(a => a.id)) + 1 : 1,
                userId: app.currentUser.id,
                description: description,
                images: app.answerImages.slice(),
                answeredAt: new Date().toISOString(),
                isAccepted: false,
                questionId: questionId
            };

            question.answers.push(newAnswer);
            // è³ªå•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ãã®ã¾ã¾ (reserved)
            db.saveQuestions();
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’å‰Šé™¤
            delete app.answerTimers[questionId];
            
            alert('å›ç­”ã‚’æå‡ºã—ã¾ã—ãŸï¼è³ªå•è€…ãŒæ¡ç”¨ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚');
            closeAnswerModal();
            router.navigate('question', questionId); // å›ç­”è©³ç´°ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        }
        
        function handleAcceptAnswer(questionId, answerId) {
            const question = db.questions.find(q => q.id === questionId);
            if (!question || question.userId !== app.currentUser.id || question.status === 'solved') {
                alert('ã“ã®è³ªå•ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚');
                return;
            }
            
            if (confirm('ã“ã®å›ç­”ã‚’æ¡ç”¨ã—ã€è³ªå•ã‚’è§£æ±ºæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ\næ¡ç”¨å¾Œã¯ã‚„ã‚Šç›´ã—ã§ãã¾ã›ã‚“ã€‚')) {
                const answer = question.answers.find(a => a.id === answerId);
                if (answer) {
                    answer.isAccepted = true;
                    question.status = 'solved';
                    
                    // ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
                    delete app.answerTimers[questionId];
                    
                    // å ±é…¬è¨ˆç®—ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰
                    // å®Ÿéš›ã«ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æ±ºæ¸ˆå‡¦ç†ã‚’è¡Œã„ã€PayPayã«æ‰•ã„å‡ºã—APIã‚’å‘¼ã³å‡ºã™
                    const reward = Math.floor(question.price * 0.9); 
                    
                    db.saveQuestions();
                    alert(`å›ç­”ã‚’æ¡ç”¨ã—ã¾ã—ãŸï¼å›ç­”è€…ï¼ˆ${getUserName(answer.userId)}ï¼‰ã«å ±é…¬Â¥${reward.toLocaleString()}ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚`);
                    router.navigate('question', questionId);
                }
            }
        }

        function handleDeleteQuestion(questionId) {
            const questionIndex = db.questions.findIndex(q => q.id === questionId);
            
            if (questionIndex !== -1 && db.questions[questionIndex].userId === app.currentUser.id) {
                if (confirm('æœ¬å½“ã«ã“ã®è³ªå•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    db.questions.splice(questionIndex, 1);
                    db.saveQuestions();
                    alert('è³ªå•ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
                    router.navigate('home');
                }
            }
        }
        
        function viewNewAnswers() {
            // æ–°ç€å›ç­”ã®ã‚ã‚‹è³ªå•ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã‹ã€ã¾ã¨ã‚ã¦æ—¢èª­ã«ã™ã‚‹ãªã©ã®å‡¦ç†
            const newAnswers = checkNewAnswers();
            const answerIds = newAnswers.flatMap(q => q.answers).map(a => a.id);
            
            // å…¨ã¦æ—¢èª­ã«ã™ã‚‹
            app.viewedAnswers = [...new Set([...app.viewedAnswers, ...answerIds])];
            localStorage.setItem('lazyum_viewed_answers', JSON.stringify(app.viewedAnswers));

            if (newAnswers.length > 0) {
                 // æœ€åˆã®è³ªå•ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                router.navigate('question', newAnswers[0].id);
            } else {
                router.render('home');
            }
        }

        // æŠ•ç¨¿ãƒšãƒ¼ã‚¸å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯
        const categoryMap = {
            'ç¤¾ä¼šäºº': ['ä»•äº‹', 'è»¢è·', 'è³‡æ ¼'],
            'å¤§å­¦ç”Ÿ': ['å­¦æ¥­', 'å°±æ´»', 'ã‚µãƒ¼ã‚¯ãƒ«'],
            'é«˜æ ¡ç”Ÿ': ['å—é¨“', 'é€²è·¯', 'éƒ¨æ´»'],
            'ä¸­å­¦ç”Ÿ': ['å‹‰å¼·', 'å‹äºº', 'ç¿’ã„äº‹'],
            'å°å­¦ç”Ÿ': ['å®¿é¡Œ', 'éŠã³', 'å­¦æ ¡'],
            'ãã®ä»–': ['è¶£å‘³', 'ç”Ÿæ´»', 'é›‘è«‡']
        };

        const subCategoryMap = {
            'ä»•äº‹': ['ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'ãƒ‡ã‚¶ã‚¤ãƒ³', 'å–¶æ¥­'],
            'å­¦æ¥­': ['æ•°å­¦', 'è‹±èª', 'ãƒ¬ãƒãƒ¼ãƒˆ'],
            'å—é¨“': ['å…±é€šãƒ†ã‚¹ãƒˆ', 'äºŒæ¬¡è©¦é¨“', 'æ¨è–¦'],
            'å‹‰å¼·': ['å›½èª', 'ç†ç§‘', 'ç¤¾ä¼š'],
            'å®¿é¡Œ': ['æ¼¢å­—', 'è¨ˆç®—', 'è‡ªç”±ç ”ç©¶'],
            'è¶£å‘³': ['æ–™ç†', 'ã‚¹ãƒãƒ¼ãƒ„', 'ã‚²ãƒ¼ãƒ ']
        };

        function initPostPage() {
            updateSubCategory();
            updateRewardDisplay();
        }

        function updateSubCategory() {
            const mainCategory = document.getElementById('postCategory').value;
            const subCategorySelect = document.getElementById('postSubCategory');
            const subCategoryGroup = document.getElementById('subCategoryGroup');
            
            subCategorySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            subCategoryGroup.style.display = 'none';
            
            if (mainCategory && categoryMap[mainCategory]) {
                const subCategories = categoryMap[mainCategory];
                subCategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subCategorySelect.appendChild(option);
                });
                subCategoryGroup.style.display = 'block';
            }
            
            updateDetailCategory();
        }

        function updateDetailCategory() {
            const subCategory = document.getElementById('postSubCategory').value;
            const detailCategorySelect = document.getElementById('postDetailCategory');
            const detailCategoryGroup = document.getElementById('detailCategoryGroup');

            detailCategorySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            detailCategoryGroup.style.display = 'none';

            if (subCategory && subCategoryMap[subCategory]) {
                const detailCategories = subCategoryMap[subCategory];
                detailCategories.forEach(detail => {
                    const option = document.createElement('option');
                    option.value = detail;
                    option.textContent = detail;
                    detailCategorySelect.appendChild(option);
                });
                detailCategoryGroup.style.display = 'block';
            }
            checkFormCompletion();
        }
        
        function updateRewardDisplay() {
            const priceInput = document.getElementById('postPrice');
            const rewardDiv = document.getElementById('rewardDisplay');
            const price = parseInt(priceInput.value, 10);
            
            if (price >= 100) {
                const commissionRate = 0.1; // 10%
                const commission = Math.floor(price * commissionRate);
                const actualReward = price - commission;
                
                rewardDiv.innerHTML = `
                    æ±ºæ¸ˆé‡‘é¡: Â¥${price.toLocaleString()} <br>
                    æ‰‹æ•°æ–™ (10%): -Â¥${commission.toLocaleString()} <br>
                    **å›ç­”è€…ã¸ã®å ±é…¬:** **Â¥${actualReward.toLocaleString()}**
                `;
                rewardDiv.style.display = 'block';
            } else {
                rewardDiv.style.display = 'none';
            }
        }
        
        function checkFormCompletion() {
            const title = document.getElementById('postTitle')?.value;
            const description = document.getElementById('postDescription')?.value;
            const category = document.getElementById('postCategory')?.value;
            const price = parseInt(document.getElementById('postPrice')?.value, 10);
            
            updateRewardDisplay();

            let isComplete = !!title && !!description && !!category && price >= 100;
            
            // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®é¸æŠã‚‚å¿…é ˆ
            const subCategoryGroup = document.getElementById('subCategoryGroup');
            if (subCategoryGroup && subCategoryGroup.style.display !== 'none') {
                const subCategory = document.getElementById('postSubCategory')?.value;
                isComplete = isComplete && !!subCategory;
            }
            
            // è©³ç´°ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®é¸æŠã‚‚å¿…é ˆ
            const detailCategoryGroup = document.getElementById('detailCategoryGroup');
            if (detailCategoryGroup && detailCategoryGroup.style.display !== 'none') {
                 const detailCategory = document.getElementById('postDetailCategory')?.value;
                 isComplete = isComplete && !!detailCategory;
            }
            
            const warningDiv = document.getElementById('incompleteWarning');
            const payButton = document.getElementById('payButton');

            if (warningDiv && payButton) {
                if (isComplete) {
                    warningDiv.style.display = 'none';
                    payButton.disabled = false;
                } else {
                    warningDiv.style.display = 'block';
                    payButton.disabled = true;
                }
            }
        }
        
        // ğŸ’¡ ä¿®æ­£: PayPayæ±ºæ¸ˆå‡¦ç†ã‚’æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«çµ±åˆ
        async function initiatePayPay() {
            const payButton = document.getElementById('payButton');
            const paymentMessage = document.getElementById('paymentMessage');
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›å€¤ã‚’å–å¾—
            const amount = parseInt(document.getElementById('postPrice').value, 10);

            if (payButton.disabled || isNaN(amount) || amount < 100) {
                 paymentMessage.textContent = 'å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                 paymentMessage.style.color = 'red';
                 return;
            }
            
            paymentMessage.textContent = 'æ±ºæ¸ˆå‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
            paymentMessage.style.color = 'blue';
            payButton.disabled = true;

            // è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ä¿å­˜ (æ±ºæ¸ˆæˆåŠŸå¾Œã®æŠ•ç¨¿å‡¦ç†ã§ä½¿ç”¨)
            const newQuestionData = {
                title: document.getElementById('postTitle').value,
                description: document.getElementById('postDescription').value,
                category: document.getElementById('postCategory').value,
                subCategory: document.getElementById('postSubCategory').value || null,
                detailCategory: document.getElementById('postDetailCategory').value || null,
                price: amount,
                deadline: document.getElementById('postDeadline').value || null,
                images: app.selectedImages.slice(),
                userId: app.currentUser.id,
                answers: []
            };
            sessionStorage.setItem('pending_question_data', JSON.stringify(newQuestionData));
            
            try {
                // Netlify Function (create-payment.js) ã‚’å‘¼ã³å‡ºã™
                const response = await fetch('/.netlify/functions/create-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    // é‡‘é¡ã‚’ Netlify Function ã«é€ä¿¡
                    body: JSON.stringify({ amount: amount }),
                });

                const result = await response.json();

                if (response.ok && result.success && result.paymentUrl) {
    paymentMessage.textContent = 'PayPayæ±ºæ¸ˆç”»é¢ã¸ç§»å‹•ã—ã¾ã™...';
    window.location.href = result.paymentUrl;
} else {
    const errorMsg = result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
    paymentMessage.textContent = `æ±ºæ¸ˆä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorMsg}`;
    paymentMessage.style.color = 'red';
    console.error('Payment creation failed:', result);
    payButton.disabled = false;
}

            } catch (error) {
                paymentMessage.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                paymentMessage.style.color = 'red';
                console.error('Fetch error:', error);
                payButton.disabled = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            }
        }

        // æ±ºæ¸ˆæˆåŠŸå¾Œã®å‡¦ç†ï¼ˆå®Ÿéš›ã«ã¯complete.htmlã§è¡Œã†ã¹ãã ãŒã€ã“ã“ã§ã¯ãƒ€ãƒŸãƒ¼ï¼‰
        function handlePost(e) {
            e.preventDefault();
            // initiatePayPay()ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç§»å‹•ã—ãŸãŸã‚ã€ã“ã®é–¢æ•°ã¯åŸºæœ¬ä½¿ã‚ãªã„ã€‚
            // å¿µã®ãŸã‚ã€ãƒã‚°é˜²æ­¢ã®ãŸã‚ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç©ºã«ã™ã‚‹ã€‚
            return false;
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã¨ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
        function initializeApp() {
            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
            if (db.users.length === 0) {
                db.users.push({
                    id: 1,
                    name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                    email: 'test@test.com',
                    password: 'password',
                    googleId: null,
                    createdAt: new Date().toISOString()
                });
                db.saveUsers();
            }
            
            app.currentUser = db.getCurrentUser();
            
            // URLãƒãƒƒã‚·ãƒ¥ã«åŸºã¥ã„ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
            const hash = location.hash.slice(1) || (app.currentUser ? 'home' : 'login');
            
            // ãƒãƒƒã‚·ãƒ¥ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒšãƒ¼ã‚¸ã¨IDã‚’å–å¾—
            const [page, id] = hash.split('/');
            
            if (page) {
                // ğŸ’¡ æ±ºæ¸ˆå®Œäº†å¾Œã®æŠ•ç¨¿å‡¦ç† (URLã‹ã‚‰ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯)
                if (page === 'post-complete') {
                    handlePaymentSuccess();
                } else {
                    router.render(page, id);
                }
            } else {
                router.render(app.currentUser ? 'home' : 'login');
            }
        }

        function handlePaymentSuccess() {
            // å®Ÿéš›ã¯complete.htmlã§è¡Œã†å‡¦ç†ã®ãƒ€ãƒŸãƒ¼
            const pendingData = sessionStorage.getItem('pending_question_data');
            sessionStorage.removeItem('pending_question_data');

            if (!pendingData) {
                alert('æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æŠ•ç¨¿ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚');
                router.navigate('post');
                return;
            }

            const newQuestionData = JSON.parse(pendingData);
            
            // æ–°ã—ã„è³ªå•IDã‚’æ¡ç•ª
            const newId = db.questions.length > 0 ? Math.max(...db.questions.map(q => q.id)) + 1 : 1;
            
            const newQuestion = {
                id: newId,
                title: newQuestionData.title,
                description: newQuestionData.description,
                category: newQuestionData.category,
                subCategory: newQuestionData.subCategory,
                detailCategory: newQuestionData.detailCategory,
                price: newQuestionData.price,
                deadline: newQuestionData.deadline,
                images: newQuestionData.images,
                userId: app.currentUser.id,
                status: 'open',
                answers: [],
                createdAt: new Date().toISOString()
            };
            
            db.questions.push(newQuestion);
            db.saveQuestions();
            
            alert('æ±ºæ¸ˆãŒå®Œäº†ã—ã€è³ªå•ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸï¼');
            router.navigate('question', newId);
        }

        // åˆæœŸåŒ–
        window.onload = function() {
            initializeApp();
            
            // ã‚¿ã‚¤ãƒãƒ¼ç›£è¦–
            setInterval(() => {
                // home ã¾ãŸã¯ question ãƒšãƒ¼ã‚¸ã«ã„ã‚‹å ´åˆã®ã¿æ›´æ–°
                if (app.currentPage === 'home' || (app.currentPage === 'question' && app.currentQuestion)) {
                    // å…¨ã¦ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’å†ç¢ºèªã—ã€è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãŸã ã—DOMè¦ç´ ã®å–å¾—ã¯router.renderã§å®Ÿè¡Œï¼‰
                    router.render(app.currentPage, app.currentQuestion?.id);
                } else if (app.currentPage === 'question') {
                    // questionãƒšãƒ¼ã‚¸ã ãŒã€å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°ã‚’è©¦ã¿ã‚‹
                    const timer = document.querySelector('.timer');
                    if (timer) {
                        const questionId = app.currentQuestion?.id;
                        if (questionId && app.answerTimers[questionId]) {
                             timer.textContent = timerManager.getRemainingTime(questionId);
                        }
                    }
                }
            }, 1000);
        };

        // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹/é€²ã‚€ãƒœã‚¿ãƒ³å¯¾å¿œ
        if (window.location.protocol !== 'about:') {
            window.addEventListener('popstate', function() {
                const hash = location.hash.slice(1) || (app.currentUser ? 'home' : 'login');
                const [page, id] = hash.split('/');
                router.render(page, id);
            });
        }
    </script>
</body>
</html>